name: Reference Docs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: {}

jobs:
  docs-check:
    name: Check generated reference docs are up to date
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: false

      - name: Setup PHP
        uses: shivammathur/setup-php@db91e1a0e48e84637d325a7ee4d2677e146ceec4  # v2.36.0
        with:
          php-version: '8.4'
          extensions: sodium, pdo

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Generate documentation
        run: php docs/reference/generate.php

      - name: Check for uncommitted changes
        run: |
          git add docs/reference/
          if ! git diff --cached --quiet docs/reference/; then
            echo "::error::Generated documentation is out of date. Run 'php docs/reference/generate.php' and commit the changes."
            echo ""
            echo "Changed files:"
            git diff --cached --name-only docs/reference/
            echo ""
            echo "Diff:"
            git diff --cached docs/reference/
            exit 1
          fi
          echo "Documentation is up to date."
